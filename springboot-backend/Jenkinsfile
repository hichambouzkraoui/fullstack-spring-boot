pipeline {
  environment {
    registry = '621650508462.dkr.ecr.us-east-1.amazonaws.com/springboot-backend'
    registryCredential = 'aws-credentials'
    dockerImage = ''
  }
    agent any
    stages {
        stage("Env Variables") {
            steps {
                    sh "printenv"
            }
        }
        stage('UnitTests') {
            when {
                not { branch 'main' }
            }
            steps {
                dir("springboot-backend"){
                    sh 'mvn test -Dgroups="UnitTests"'
                }
            }
        }
        stage('Package') {
            steps {
                dir("springboot-backend"){
                    sh 'mvn package -DskipTests'
                }
            }
        }

        stage('Building docker image') {
            when {
                expression {
                branchName = env.CHANGE_TARGET ? env.CHANGE_TARGET : env.BRANCH_NAME
                return branchName = 'main'
                echo branchName
                echo env.BRANCH_NAME
                }
            }
            steps {
                dir("springboot-backend") {
                    script {
                        dockerImage = docker.build registry
                    }
                }
            }
        }
        stage('Deploy image to AWS ECR') {
            when {
                expression {
                branchName = env.CHANGE_TARGET ? env.CHANGE_TARGET : env.BRANCH_NAME
                return branchName = 'main'
                echo branchName
                echo env.BRANCH_NAME
                }
            }
            steps {
                script {
                    docker.withRegistry("https://" + registry, "ecr:us-east-1:" + registryCredential) {
                        dockerImage.push("${env.BUILD_NUMBER}")
                        dockerImage.push("latest")
                    }
                }
            }
        }
    }
}